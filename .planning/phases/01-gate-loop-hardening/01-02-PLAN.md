---
phase: 01-gate-loop-hardening
plan: 02
type: execute
wave: 1
depends_on: ["01-01"]
files_modified:
  - hooks/steer-gate-hook.js
  - hooks/cursor-hooks.example.json
  - packages/cursor-extension/src/extension.ts
  - packages/cursor-extension/src/SessionState.ts
  - packages/cursor-extension/src/StatusPanel.ts
  - packages/cursor-extension/src/WizardPanel.ts
  - packages/core/src/routeModel.ts
  - packages/core/src/types.ts
autonomous: true
requirements:
  - HOOK-01
  - HOOK-02
  - HOOK-04
  - HOOK-05
  - EXT-05
  - REL-02
  - REL-03
  - SESS-02
  - ROUT-04

must_haves:
  truths:
    - "Hook blocks score <= 3, passes everything else"
    - "Hook completes in under 3 seconds for typical prompts"
    - "Extension activates without errors even if chat participant API fails"
    - "Session taskId persists across Cursor restarts via workspaceState"
    - "StatusPanel shows score (colored), status, mode, model tier, gate call count"
    - "WizardPanel shows follow-ups, patched prompt, model suggestion with cost, Copy Prompt"
    - "routeModel returns modelName and provider alongside tier"
  artifacts:
    - path: "hooks/steer-gate-hook.js"
      provides: "CJS hook for beforeSubmitPrompt with score-based blocking"
    - path: "packages/cursor-extension/src/extension.ts"
      provides: "Hardened extension activation with try/catch on all registrations"
    - path: "packages/cursor-extension/src/StatusPanel.ts"
      provides: "Score display with color, status badge, mode, model tier, gate count"
    - path: "packages/cursor-extension/src/WizardPanel.ts"
      provides: "Follow-ups, patched prompt, model info with cost, Copy Prompt button"
---

<objective>
Make the hook reliable and the extension panels useful. The hook is the entry point (blocks garbage), the panels are where developers see value (score + patched prompt + model suggestion).

Days 2-4. The bulk of the work.
</objective>

<context>
@hooks/steer-gate-hook.js
@hooks/cursor-hooks.example.json
@packages/cursor-extension/src/extension.ts
@packages/cursor-extension/src/SessionState.ts
@packages/cursor-extension/src/StatusPanel.ts
@packages/cursor-extension/src/WizardPanel.ts
@packages/core/src/routeModel.ts
@packages/core/src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Hook verification + model routing enrichment</name>
  <files>
    hooks/steer-gate-hook.js
    hooks/cursor-hooks.example.json
    packages/core/src/routeModel.ts
    packages/core/src/types.ts
  </files>
  <action>
1. **Verify hook works** — read hooks/steer-gate-hook.js. Confirm:
   - CJS format (require, not import)
   - Reads stdin JSON, extracts prompt
   - Calls gate() from core
   - Score <= 3 → `{ continue: false }`
   - Score 4-6 → `{ continue: true }` (with guidance in user_message if supported)
   - Score >= 7 → `{ continue: true }`
   - Git execSync has timeout: 3000
   - If anything is wrong, fix it. If it's already correct, leave it alone.

2. **Verify cursor-hooks.example.json** exists and has correct structure.

3. **Add modelName and provider to RouteResult** in packages/core/src/types.ts:
   - Add `modelName: string` and `provider: string` to `RouteResult` interface

4. **Add tier-to-model mapping in routeModel.ts**:
   ```typescript
   const TIER_MODELS: Record<string, { modelName: string; provider: string }> = {
     small: { modelName: "claude-3-5-haiku-latest", provider: "anthropic" },
     mid: { modelName: "claude-sonnet-4-20250514", provider: "anthropic" },
     high: { modelName: "claude-opus-4-20250514", provider: "anthropic" },
   };
   ```
   After determining tier, set modelName and provider from the lookup.

5. **Run existing tests** to confirm no regressions: `npx vitest run`
  </action>
  <verify>
    `echo '{"prompt":"fix it"}' | node hooks/steer-gate-hook.js` returns JSON with `continue: false`.
    `echo '{"prompt":"## GOAL\nAdd auth\n## LIMITS\nOnly src/auth\n## REVIEW\nTests pass"}' | node hooks/steer-gate-hook.js` returns JSON with `continue: true`.
    `npx vitest run` passes all existing tests.
  </verify>
  <done>
    Hook verified working for all 3 score ranges. Model routing returns modelName and provider. No regressions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extension hardening + session persistence + panel polish</name>
  <files>
    packages/cursor-extension/src/extension.ts
    packages/cursor-extension/src/SessionState.ts
    packages/cursor-extension/src/StatusPanel.ts
    packages/cursor-extension/src/WizardPanel.ts
  </files>
  <action>
1. **Harden extension.ts activation**:
   - Wrap chat participant registration (`vscode.chat.createChatParticipant`) in try/catch:
     ```typescript
     try {
       // existing chat participant code
     } catch (err) {
       console.warn("[steer] Chat participant unavailable:", err);
     }
     ```
   - Wrap each panel registration in try/catch with `vscode.window.showErrorMessage` on failure
   - Wrap gate() calls in try/catch — show error notification instead of silent failure
   - On gate failure, still update panel with error state (not blank/stale)

2. **Fix session persistence in SessionState.ts**:
   - On activate: load taskId from `context.workspaceState.get("steer.taskId")`
   - On gate call: save taskId to `context.workspaceState.update("steer.taskId", taskId)`
   - Only reset taskId when user explicitly triggers "New Task" command
   - Increment turnId on each gate call, persist it
   - Track gateCallCount, persist it

3. **StatusPanel polish**:
   - Score: large number, colored (red <= 3, yellow 4-6, green >= 7)
   - Status badge: BLOCKED (red), NEEDS_INFO (yellow), READY (green)
   - Mode: current mode name
   - Model tier: from last gate result
   - Gate call count: simple counter
   - Task ID + Turn: if available
   - Keep it simple HTML. No sparklines. No trends. No charts.

4. **WizardPanel polish**:
   - Follow-up questions: render each question with its options/input
   - Patched prompt: show the full patched prompt in a code block
   - Model suggestion: show tier + modelName + provider + estimated cost
   - Copy Prompt button: sends message to extension, copies patched prompt to clipboard
   - No diff view. No Send Patched flow. No override audit. Keep it simple.

5. **Verify build**: `npm run build` for cursor-extension must succeed.
  </action>
  <verify>
    `npm run build` for cursor-extension succeeds. Extension TypeScript compiles without errors. No import of vscode in core packages.
  </verify>
  <done>
    Extension activates gracefully. Session persists across restarts. StatusPanel shows score/status/mode/model/count. WizardPanel shows follow-ups/prompt/model/cost/copy. All wrapped in error handling.
  </done>
</task>

</tasks>

<verification>
1. Hook blocks "fix it" and passes structured prompts
2. Extension builds and activates without errors
3. Panels show useful information (score, status, patched prompt)
4. Session state persists taskId across simulated restart
5. Chat participant failure doesn't crash extension
</verification>

<output>
After completion, create `.planning/phases/01-gate-loop-hardening/01-02-SUMMARY.md`
</output>
