---
phase: 01-gate-loop-hardening
plan: 03
type: execute
wave: 1
depends_on: ["01-02"]
files_modified:
  - packages/core/src/telemetry.ts
  - packages/cursor-extension/src/extension.ts
  - docs/SETUP.md
  - docs/PILOT.md
autonomous: true
requirements:
  - TELE-01
  - TELE-02

must_haves:
  truths:
    - "Telemetry writes JSONL to absolute path in extension context (globalStorageUri)"
    - "Telemetry writes JSONL to cwd-based path in CLI context"
    - "Each JSONL record has: timestamp, taskId, turnId, mode, score, status, missing, modelTier, estimatedCost, hasGitImpact"
    - "SETUP.md gets a developer from zero to working in 15 minutes"
    - "Demo script shows BLOCKED → NEEDS_INFO → READY"
  artifacts:
    - path: "packages/core/src/telemetry.ts"
      provides: "Telemetry append with explicit path parameter"
    - path: "docs/SETUP.md"
      provides: "Installation guide for CoinSwitch pilot"
    - path: "docs/PILOT.md"
      provides: "What we're measuring and how to extract metrics"
---

<objective>
Fix telemetry so we can actually measure the pilot. Write docs so 14 developers can install in 15 minutes.

Days 5-6. Mostly writing, not coding.
</objective>

<context>
@packages/core/src/telemetry.ts
@packages/cursor-extension/src/extension.ts
@packages/cli/src/steer.ts
@docs/SETUP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix telemetry path and enrich records</name>
  <files>
    packages/core/src/telemetry.ts
    packages/cursor-extension/src/extension.ts
  </files>
  <action>
1. **Update telemetry.ts append() signature**:
   - Make the file path a required parameter (not optional with relative default)
   - `export async function append(data: Record<string, unknown>, filePath: string): Promise<void>`
   - Create directory if needed: `await mkdir(dirname(filePath), { recursive: true })`
   - If callers were passing no path, fix them to pass an explicit absolute path

2. **Update extension.ts telemetry wiring**:
   - After gate() calls in the extension, call telemetry.append() with:
     ```typescript
     const telemetryDir = context.globalStorageUri.fsPath;
     await vscode.workspace.fs.createDirectory(context.globalStorageUri);
     const telemetryPath = path.join(telemetryDir, "telemetry.jsonl");
     ```
   - Each record includes: timestamp, taskId, turnId, mode, score, status, missing (array), modelTier, estimatedCostUsd, hasGitImpact (boolean)
   - Call append() directly after gate() — no EventBus, no subscription pattern. Just a function call.
   - Wrap in try/catch — telemetry must never crash the extension

3. **Update CLI telemetry** (if steer.ts calls append):
   - Use `path.resolve(process.cwd(), "data", "telemetry.jsonl")` as the path
   - Same record format

4. **Verify**: run the existing gate tests, confirm telemetry function signature change doesn't break anything.
  </action>
  <verify>
    `npm run build` for core and cursor-extension succeeds. `npx vitest run` passes.
  </verify>
  <done>
    Telemetry append() requires explicit absolute path. Extension uses globalStorageUri. CLI uses cwd-based path. Records include all required fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write SETUP.md and PILOT.md</name>
  <files>
    docs/SETUP.md
    docs/PILOT.md
  </files>
  <action>
1. **Write docs/SETUP.md** — installation guide for CoinSwitch:
   - Prerequisites: Node.js >= 18, Cursor IDE
   - Step 1: Clone repo, npm install, npm run build
   - Step 2: Install Cursor extension (link to .vsix or dev install)
   - Step 3: Configure hook — copy cursor-hooks.example.json to ~/.cursor/hooks/hooks.json (or wherever Cursor reads it), adjust path to steer-gate-hook.js
   - Step 4: Configure MCP — add steer.gate to Cursor MCP settings (show exact JSON)
   - Step 5: Verify — run `bash hooks/demo.sh`, check extension panel appears, test steer.gate via MCP
   - Troubleshooting: common issues (hook not firing, MCP not connecting, extension not showing)

2. **Write docs/PILOT.md** — what we're measuring:
   - Metrics: gate calls/day per developer, average score, block rate (% of prompts scoring <= 3), override rate, most common missing sections
   - How to extract: `cat <telemetry-path>/telemetry.jsonl | jq .score` and similar one-liners
   - Success criteria after 2 weeks: block rate decreasing, average score increasing, developers not disabling the tool
   - What to watch for: if override rate > 50% → threshold too aggressive; if avg score not improving → scoring may not be teaching

3. **Verify demo.sh still works**: `bash hooks/demo.sh` shows 3 cases correctly.
  </action>
  <verify>
    docs/SETUP.md exists with step-by-step instructions. docs/PILOT.md exists with metrics and extraction commands. `bash hooks/demo.sh` passes all 3 cases.
  </verify>
  <done>
    SETUP.md enables 15-minute installation. PILOT.md defines what we measure and how. Demo script works.
  </done>
</task>

</tasks>

<verification>
1. Telemetry writes to correct path in extension context
2. JSONL records have all required fields
3. SETUP.md is clear and complete
4. PILOT.md defines measurable success criteria
5. Demo script works
</verification>

<output>
After completion, create `.planning/phases/01-gate-loop-hardening/01-03-SUMMARY.md`
</output>
