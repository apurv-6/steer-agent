---
phase: 01-core-infrastructure-pilot-reliability
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - packages/core/src/gate.ts
  - packages/core/src/scorePrompt.ts
  - packages/core/src/routeModel.ts
  - packages/core/src/telemetry.ts
  - packages/core/src/index.ts
  - packages/core/src/__tests__/gate.test.ts
  - packages/core/src/__tests__/scorePrompt.test.ts
autonomous: true
requirements:
  - GATE-01
  - GATE-03
  - GATE-06
  - GATE-07
  - GATE-08
  - ROUT-01
  - ROUT-02
  - ROUT-03
  - ROUT-04
  - GIT-01
  - GIT-02
  - GIT-04
  - ARCH-06
  - TELE-01
  - TELE-02
  - TELE-03
  - CONF-03

must_haves:
  truths:
    - "gate() returns GateResult with criterionScores breakdown showing per-criterion score, max, and reason"
    - "gate() emits gate:result event on EventBus after computing result"
    - "routeModel() returns modelName and provider alongside tier"
    - "telemetry.subscribeToEventBus() auto-captures gate:result events to JSONL file"
    - "telemetry accepts an absolute file path, not a relative default"
    - "gate() completes in under 200ms for typical prompts"
  artifacts:
    - path: "packages/core/src/gate.ts"
      provides: "Canonical gate with EventBus emission"
      exports: ["gate"]
    - path: "packages/core/src/scorePrompt.ts"
      provides: "Per-criterion scoring breakdown"
      exports: ["scorePrompt"]
    - path: "packages/core/src/routeModel.ts"
      provides: "Explainable routing with model name and provider"
      exports: ["routeModel", "estimateCost"]
    - path: "packages/core/src/telemetry.ts"
      provides: "EventBus-driven auto-capture telemetry"
      exports: ["append", "subscribeToEventBus"]
  key_links:
    - from: "packages/core/src/gate.ts"
      to: "packages/core/src/eventBus.ts"
      via: "eventBus.emit('gate:result', result) at end of gate()"
      pattern: "eventBus\\.emit.*gate:result"
    - from: "packages/core/src/telemetry.ts"
      to: "packages/core/src/eventBus.ts"
      via: "subscribeToEventBus() listens for gate:result"
      pattern: "bus\\.on.*gate:result"
    - from: "packages/core/src/gate.ts"
      to: "packages/core/src/scorePrompt.ts"
      via: "gate() uses scorePrompt() which now returns criterionScores"
      pattern: "scorePrompt.*criterionScores"
---

<objective>
Enhance gate() to emit events on the EventBus, add per-criterion transparent scoring breakdown to scorePrompt(), add model name/provider to routeModel(), and wire telemetry to auto-capture via EventBus subscription.

Purpose: This makes gate() the observable single source of truth. Every gate call emits an event that telemetry captures automatically, SessionStore can subscribe to, and the hook bridge can relay. The per-criterion scoring breakdown enables the WizardPanel to show exactly why a prompt scored as it did.

Output: Enhanced gate.ts, scorePrompt.ts, routeModel.ts, telemetry.ts -- all wired through the EventBus from Plan 01-01.
</objective>

<execution_context>
@/Users/devapu/.claude/get-shit-done/workflows/execute-plan.md
@/Users/devapu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-infrastructure-pilot-reliability/01-RESEARCH.md
@.planning/phases/01-core-infrastructure-pilot-reliability/01-01-SUMMARY.md

@packages/core/src/gate.ts
@packages/core/src/scorePrompt.ts
@packages/core/src/routeModel.ts
@packages/core/src/telemetry.ts
@packages/core/src/types.ts
@packages/core/src/index.ts
@packages/core/src/eventBus.ts
@packages/core/src/sessionStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add per-criterion scoring, model name/provider, EventBus emission, and telemetry subscription</name>
  <files>
    packages/core/src/scorePrompt.ts
    packages/core/src/routeModel.ts
    packages/core/src/gate.ts
    packages/core/src/telemetry.ts
    packages/core/src/index.ts
  </files>
  <action>
1. **Update `packages/core/src/scorePrompt.ts`** (GATE-03 -- transparent scoring):
   - Import `CriterionScore` from types.ts
   - Add a `criterionScores: Record<string, CriterionScore>` field to the returned `ScoreResult`
   - Track per-criterion scores as the function evaluates:
     - `"goal"`: max 2, score 2 if GOAL section present, 0 if missing, reason: "GOAL section present/missing"
     - `"limits"`: max 2, score 2 if LIMITS section present, 0 if missing, reason: "LIMITS section present/missing"
     - `"review"`: max 2, score 2 if REVIEW/VERIFICATION section present, 0 if missing
     - `"clarity"`: max 1, score 0 if vague verbs found, 1 otherwise, reason lists the vague verbs
     - `"scope"`: max 1, score 0 if file refs without scope definition, 1 otherwise
   - The overall score calculation remains the same (existing behavior preserved)
   - Return `criterionScores` as part of ScoreResult

2. **Update `packages/core/src/routeModel.ts`** (ROUT-04 -- model name and provider):
   - Add a lookup map for tier -> default model:
     ```typescript
     const TIER_MODELS: Record<string, { modelName: string; provider: string }> = {
       small: { modelName: "claude-3-5-haiku-latest", provider: "anthropic" },
       mid: { modelName: "claude-sonnet-4-20250514", provider: "anthropic" },
       high: { modelName: "claude-opus-4-20250514", provider: "anthropic" },
     };
     ```
   - After determining tier, set `modelName` and `provider` from the lookup
   - Return these in the RouteResult (the type was already updated in Plan 01-01)

3. **Update `packages/core/src/gate.ts`** (ARCH-06 -- EventBus emission):
   - Import `eventBus` from `./eventBus.js`
   - After assembling the `GateResult` object (just before the `return` statement), add:
     ```typescript
     try { eventBus.emit("gate:result", result); } catch { /* best-effort */ }
     ```
   - Wrap in try/catch so EventBus errors never break gate() execution (GATE-08 perf guarantee)
   - Also add `criterionScores` from scoreResult to the GateResult. Add the field to GateResult interface in types.ts:
     ```typescript
     criterionScores: Record<string, CriterionScore>;
     ```

4. **Update `packages/core/src/telemetry.ts`** (TELE-02, TELE-03):
   - Import `SteerEventBus` type from `./eventBus.js`
   - Add `subscribeToEventBus(bus: SteerEventBus, filePath: string): void` function:
     ```typescript
     export function subscribeToEventBus(bus: SteerEventBus, filePath: string): void {
       bus.on("gate:result", (result) => {
         append({
           timestamp: new Date().toISOString(),
           event: "gate:result",
           taskId: result.taskId,
           turnId: result.turnId,
           score: result.score,
           status: result.status,
           modelTier: result.modelSuggestion.tier,
           modelName: result.modelSuggestion.modelName,
           costEstimate: result.costEstimate.estimatedCostUsd,
           hasGitImpact: !!result.gitImpact,
           nextAction: result.nextAction,
         }, filePath).catch(() => { /* best-effort telemetry */ });
       });
     }
     ```
   - Keep existing `append()` function unchanged
   - Export `subscribeToEventBus` from index.ts (add to the telemetry namespace export)

5. **Update `packages/core/src/types.ts`**:
   - Add `criterionScores: Record<string, CriterionScore>` to `GateResult` interface

6. **Verify** existing GATE-01 (canonical gate), GATE-06 (nextAction), GATE-07 (all fields), GATE-08 (<200ms), ROUT-01 (explanations), ROUT-02 (git-aware), ROUT-03 (cost estimate), GIT-01/GIT-02/GIT-04 (git parsing), CONF-03 (criticalPaths), MCP-01 (GateInput params), TELE-01 (JSONL append) -- these are already implemented. Confirm no regressions by running existing tests.
  </action>
  <verify>
    Run `npx vitest run` in packages/core -- all existing tests pass. Run `npm run build` for core package. Confirm `criterionScores` appears in gate() output by temporarily adding a console.log or checking test output.
  </verify>
  <done>
    scorePrompt returns per-criterion breakdown (5 criteria with score/max/reason). routeModel returns modelName and provider. gate() emits gate:result on EventBus. telemetry.subscribeToEventBus() auto-captures events. GateResult includes criterionScores field. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update tests for enhanced scoring, routing, and gate EventBus emission</name>
  <files>
    packages/core/src/__tests__/scorePrompt.test.ts
    packages/core/src/__tests__/gate.test.ts
  </files>
  <action>
1. **Update `packages/core/src/__tests__/scorePrompt.test.ts`**:
   - Add test: scorePrompt returns criterionScores with all 5 keys (goal, limits, review, clarity, scope)
   - Add test: Missing GOAL section results in criterionScores.goal = { score: 0, max: 2, reason: expect.stringContaining("missing") }
   - Add test: All sections present results in all criterion scores at max
   - Add test: Vague verbs result in clarity criterion score = 0
   - Preserve all existing tests (they should still pass since overall score calculation is unchanged)

2. **Update `packages/core/src/__tests__/gate.test.ts`**:
   - Add test: gate() result includes criterionScores field
   - Add test: gate() result modelSuggestion includes modelName and provider strings
   - Add test: Verify EventBus receives gate:result event when gate() is called
     - Create a fresh SteerEventBus, mock the singleton (or use the singleton and subscribe)
     - Call gate(), verify the subscriber was called with the GateResult
   - Add test: gate() completes in under 200ms (GATE-08 benchmark):
     ```typescript
     const start = performance.now();
     gate({ draftPrompt: "...", mode: "dev" });
     expect(performance.now() - start).toBeLessThan(200);
     ```
   - Preserve all existing tests
  </action>
  <verify>
    Run `npx vitest run packages/core/src/__tests__/scorePrompt.test.ts packages/core/src/__tests__/gate.test.ts` -- all tests pass (both new and existing).
  </verify>
  <done>
    scorePrompt tests verify per-criterion breakdown for all 5 criteria. gate tests verify criterionScores in output, modelName/provider in modelSuggestion, EventBus emission, and <200ms performance. All existing tests remain green.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` in packages/core -- all tests pass (existing + new)
2. `npm run build` succeeds for core package
3. gate() output includes `criterionScores` with 5 keys
4. gate() output `modelSuggestion` includes `modelName` and `provider`
5. EventBus receives `gate:result` event on every gate() call
6. telemetry.subscribeToEventBus() is exported and callable
7. No `console.log` statements in gate.ts or scorePrompt.ts (stdout clean for MCP)
</verification>

<success_criteria>
- Per-criterion scoring breakdown visible in GateResult (5 criteria with score/max/reason)
- EventBus emission from gate() verified by test
- Model routing includes specific model name and provider
- Telemetry auto-capture via EventBus subscription works
- gate() performance remains under 200ms
- All 17 requirement IDs addressed (most already done, enhanced where needed)
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure-pilot-reliability/01-02-SUMMARY.md`
</output>
