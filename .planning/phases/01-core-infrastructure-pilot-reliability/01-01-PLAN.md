---
phase: 01-core-infrastructure-pilot-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/eventBus.ts
  - packages/core/src/sessionStore.ts
  - packages/core/src/constants.ts
  - packages/core/src/types.ts
  - packages/core/src/index.ts
  - packages/core/src/__tests__/eventBus.test.ts
  - packages/core/src/__tests__/sessionStore.test.ts
autonomous: true
requirements:
  - ARCH-01
  - ARCH-02
  - ARCH-07
  - SESS-01
  - SESS-02
  - SESS-03

must_haves:
  truths:
    - "EventBus emits typed events and subscribers receive correct payloads"
    - "SessionStore tracks score trend (last 10 scores) and emits session:changed on update"
    - "SessionStore accepts a PersistenceAdapter for load/save, enabling Memento injection"
    - "All shared types (SessionStateData, EventMap, PersistenceAdapter) are exported from core index"
  artifacts:
    - path: "packages/core/src/eventBus.ts"
      provides: "Typed EventBus singleton wrapping Node.js EventEmitter"
      exports: ["SteerEventBus", "eventBus", "EventMap"]
    - path: "packages/core/src/sessionStore.ts"
      provides: "SessionStore with pluggable PersistenceAdapter"
      exports: ["SessionStore", "PersistenceAdapter", "SessionStateData", "DEFAULT_SESSION_STATE"]
    - path: "packages/core/src/constants.ts"
      provides: "Shared constants for signal file paths and storage keys"
      exports: ["SIGNAL_DIR", "SIGNAL_FILE", "STORAGE_KEY"]
    - path: "packages/core/src/types.ts"
      provides: "All shared type definitions, no duplicates across packages"
  key_links:
    - from: "packages/core/src/sessionStore.ts"
      to: "packages/core/src/eventBus.ts"
      via: "SessionStore constructor accepts SteerEventBus, emits session:changed"
      pattern: "bus\\.emit.*session:changed"
    - from: "packages/core/src/index.ts"
      to: "packages/core/src/eventBus.ts"
      via: "re-export EventBus, SessionStore, constants"
      pattern: "export.*from.*eventBus"
---

<objective>
Build the foundational primitives that all other Phase 1 plans depend on: a typed EventBus for pub/sub communication, a SessionStore with pluggable persistence, shared constants, and consolidated type definitions.

Purpose: EventBus and SessionStore are the connective tissue for gate(), telemetry, hook bridge, and extension panels. Without them, each component remains isolated. This plan creates the foundation that Plans 01-02 and 01-03 wire into.

Output: Four new core modules (eventBus.ts, sessionStore.ts, constants.ts, updated types.ts) with unit tests, all exported from core index.
</objective>

<execution_context>
@/Users/devapu/.claude/get-shit-done/workflows/execute-plan.md
@/Users/devapu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-infrastructure-pilot-reliability/01-RESEARCH.md

@packages/core/src/types.ts
@packages/core/src/index.ts
@packages/core/src/telemetry.ts
@packages/cursor-extension/src/SessionState.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EventBus, SessionStore, constants, and update types</name>
  <files>
    packages/core/src/eventBus.ts
    packages/core/src/sessionStore.ts
    packages/core/src/constants.ts
    packages/core/src/types.ts
    packages/core/src/index.ts
  </files>
  <action>
1. Create `packages/core/src/constants.ts`:
   - Export `SIGNAL_DIR = ".steer-agent"` (directory name for signal file)
   - Export `SIGNAL_FILE = "last-gate.json"` (signal file name)
   - Export `STORAGE_KEY = "steeragent.sessionState"` (persistence key)

2. Update `packages/core/src/types.ts`:
   - Add `SessionStateData` interface (move from extension's SessionState.ts, add `blockedCount: number` and `overrideCount: number` fields per SESS-01):
     ```typescript
     export interface SessionStateData {
       steerEnabled: boolean;
       mode: GateMode;
       blockThreshold: number;
       lastModelTier: string | null;
       lastPatchedPrompt: string | null;
       taskId: string | null;
       turnId: number;
       gateCallCount: number;
       blockedCount: number;
       overrideCount: number;
       lastScore: number | null;
       scoreTrend: number[];
       lastStatus: string | null;
     }
     ```
   - Add `CriterionScore` interface for transparent scoring (GATE-03):
     ```typescript
     export interface CriterionScore {
       score: number;
       max: number;
       reason: string;
     }
     ```
   - Add `criterionScores?: Record<string, CriterionScore>` to `ScoreResult`
   - Add `modelName: string` and `provider: string` to `RouteResult` (for ROUT-04)
   - Keep all existing types unchanged

3. Create `packages/core/src/eventBus.ts`:
   - Import `EventEmitter` from `node:events`
   - Define `EventMap` interface mapping event names to payload types:
     - `"gate:result"` -> `GateResult`
     - `"gate:error"` -> `{ error: string; input: unknown }`
     - `"session:changed"` -> `SessionStateData`
     - `"session:reset"` -> `void`
     - `"telemetry:event"` -> `TelemetryEvent`
     - `"hook:signal"` -> `{ source: string; result: GateResult }`
   - Create `SteerEventBus` class wrapping EventEmitter with typed `on<K>`, `off<K>`, `emit<K>`, `dispose()` methods
   - Set `emitter.setMaxListeners(20)` in constructor to prevent false memory leak warnings
   - Export singleton: `export const eventBus = new SteerEventBus()`

4. Create `packages/core/src/sessionStore.ts`:
   - Define and export `PersistenceAdapter` interface: `{ load(): SessionStateData | undefined; save(data: SessionStateData): void; }`
   - Define `DEFAULT_SESSION_STATE` constant with all fields initialized (blockedCount: 0, overrideCount: 0, scoreTrend: [], etc.)
   - Create `SessionStore` class:
     - Constructor accepts optional `PersistenceAdapter` and optional `SteerEventBus`
     - `get data()`: returns `Readonly<SessionStateData>`
     - `update(partial)`: merges partial, auto-tracks scoreTrend (append + slice(-10)) when lastScore changes, calls `persistence?.save()`, calls `bus?.emit("session:changed", state)`
     - `reset()`: resets to DEFAULT_SESSION_STATE, saves, emits `session:reset`

5. Update `packages/core/src/index.ts`:
   - Add exports for EventBus: `export { SteerEventBus, eventBus } from "./eventBus.js"; export type { EventMap } from "./eventBus.js";`
   - Add exports for SessionStore: `export { SessionStore, DEFAULT_SESSION_STATE } from "./sessionStore.js"; export type { PersistenceAdapter } from "./sessionStore.js";`
   - Add exports for constants: `export { SIGNAL_DIR, SIGNAL_FILE, STORAGE_KEY } from "./constants.js";`
   - Add `SessionStateData` and `CriterionScore` to the type exports from types.ts
  </action>
  <verify>
    Run `npx tsc --noEmit -p packages/core/tsconfig.json` (or the project's equivalent type check command) to confirm no type errors. Verify all new exports are accessible: `import { eventBus, SessionStore, SIGNAL_DIR } from "@steer-agent-tool/core"` compiles.
  </verify>
  <done>
    EventBus class exists with typed on/off/emit/dispose. SessionStore exists with PersistenceAdapter support and score trend tracking. Constants exported. All new types (SessionStateData, CriterionScore, EventMap, PersistenceAdapter) exported from core index. No duplicate type definitions between core and extension.
  </done>
</task>

<task type="auto">
  <name>Task 2: Unit tests for EventBus and SessionStore</name>
  <files>
    packages/core/src/__tests__/eventBus.test.ts
    packages/core/src/__tests__/sessionStore.test.ts
  </files>
  <action>
1. Create `packages/core/src/__tests__/eventBus.test.ts`:
   - Test: `emit("gate:result", gateResult)` triggers subscriber with correct payload
   - Test: `off()` removes subscriber (no longer called after removal)
   - Test: Multiple subscribers on same event all fire
   - Test: `dispose()` removes all listeners (verify no callbacks fire after dispose)
   - Test: Events of different types are independent (subscribing to "gate:result" does not fire on "session:changed")

2. Create `packages/core/src/__tests__/sessionStore.test.ts`:
   - Test: Default state is returned when no PersistenceAdapter provided
   - Test: `update({ lastScore: 7 })` appends to scoreTrend and persists
   - Test: scoreTrend is capped at 10 entries (update 12 times, verify length is 10 and oldest entries dropped)
   - Test: PersistenceAdapter.load() is called on construction; stored state is used
   - Test: PersistenceAdapter.save() is called on every update
   - Test: EventBus receives `session:changed` event on update
   - Test: `reset()` restores DEFAULT_SESSION_STATE and emits `session:reset`
   - Test: `data` getter returns frozen/readonly snapshot (verify updates don't mutate previous references)
   - Use a mock PersistenceAdapter: `{ load: vi.fn(), save: vi.fn() }`
   - Use a fresh `SteerEventBus` instance per test (not the singleton)
  </action>
  <verify>
    Run `npx vitest run packages/core/src/__tests__/eventBus.test.ts packages/core/src/__tests__/sessionStore.test.ts` -- all tests pass.
  </verify>
  <done>
    EventBus has 5+ passing tests covering emit/subscribe/unsubscribe/dispose. SessionStore has 8+ passing tests covering state management, persistence, score trend, and EventBus integration.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` in packages/core -- all existing tests still pass, new tests pass
2. `npm run build` succeeds for core package
3. `import { eventBus, SessionStore, SIGNAL_DIR, SIGNAL_FILE, STORAGE_KEY } from "@steer-agent-tool/core"` resolves without errors
4. No `import * as vscode` in any core file
</verification>

<success_criteria>
- EventBus singleton works with typed events (gate:result, session:changed, etc.)
- SessionStore tracks full SessionStateV1 lifecycle with pluggable persistence
- Score trend correctly maintains last 10 scores
- All types consolidated in core, no duplicates in extension
- 13+ unit tests pass covering both new modules
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-infrastructure-pilot-reliability/01-01-SUMMARY.md`
</output>
